<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GHOSTYPE BLE í…ŒìŠ¤íŠ¸ (í•œê¸€ ì§€ì›)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #333;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 700px;
            text-align: center;
        }

        .logo {
            font-size: 2.5em;
            font-weight: bold;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .status.disconnected { background: #fee; color: #c33; }
        .status.connecting { background: #fff3cd; color: #856404; }
        .status.connected { background: #d4edda; color: #155724; }

        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .message-area {
            margin: 20px 0;
        }

        input[type="text"] {
            width: 70%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 1em;
            margin-right: 10px;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .send-btn {
            padding: 12px 20px;
            font-size: 0.9em;
        }

        .conversion-preview {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            text-align: left;
            min-height: 60px;
            transition: all 0.3s ease;
        }

        .conversion-preview.korean {
            border-color: #28a745;
            background: #d4edda;
        }

        .conversion-preview.english {
            border-color: #007bff;
            background: #d1ecf1;
        }

        .conversion-preview.mixed {
            border-color: #ffc107;
            background: #fff3cd;
        }

        .protocol-info {
            font-size: 0.8em;
            color: #6c757d;
            margin-top: 5px;
        }

        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            text-align: left;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-radius: 5px;
        }

        .log-info { background: #d1ecf1; color: #0c5460; }
        .log-success { background: #d4edda; color: #155724; }
        .log-error { background: #f8d7da; color: #721c24; }
        .log-data { background: #fff3cd; color: #856404; }

        .test-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
        }

        .test-btn {
            padding: 8px 16px;
            font-size: 0.9em;
            border-radius: 20px;
            background: linear-gradient(45deg, #28a745, #20c997);
        }

        .test-btn:hover {
            background: linear-gradient(45deg, #218838, #1ea383);
        }

        .korean-test-btn {
            background: linear-gradient(45deg, #dc3545, #e83e8c);
        }

        .korean-test-btn:hover {
            background: linear-gradient(45deg, #c82333, #d91a72);
        }

        .special-btn {
            background: linear-gradient(45deg, #6f42c1, #e83e8c);
        }

        .special-btn:hover {
            background: linear-gradient(45deg, #5a2d91, #d91a72);
        }

        .keyboard-test {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 1px solid #dee2e6;
        }

        .keyboard-test h4 {
            color: #495057;
            margin-bottom: 15px;
        }

        /* ì¹´ìš´íŠ¸ë‹¤ìš´ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .countdown-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .countdown-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 30px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 90%;
            animation: modalSlide 0.3s ease-out;
        }

        @keyframes modalSlide {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .countdown-number {
            font-size: 4em;
            font-weight: bold;
            color: #667eea;
            margin: 20px 0;
            text-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .countdown-message {
            font-size: 1.2em;
            color: #333;
            margin: 20px 0;
        }

        .countdown-preview {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            color: #495057;
            word-break: break-all;
            text-align: left;
        }

        .cancel-btn {
            background: #dc3545;
            margin-top: 20px;
        }

        .cancel-btn:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .info-box {
            background: #e7f3ff;
            border: 1px solid #b8daff;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            text-align: left;
        }

        .info-box h4 {
            color: #004085;
            margin-bottom: 10px;
        }

        .info-box ul {
            margin-left: 20px;
        }

        .language-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: bold;
            margin-left: 8px;
        }

        .lang-korean {
            background: #d4edda;
            color: #155724;
        }

        .lang-english {
            background: #d1ecf1;
            color: #0c5460;
        }

        .lang-mixed {
            background: #fff3cd;
            color: #856404;
        }

        .lang-special {
            background: #e2e3e5;
            color: #383d41;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">ğŸ‘» GHOSTYPE</div>
        <div class="subtitle">BLE í‚¤ë³´ë“œ ì›¹ í…ŒìŠ¤íŠ¸ (í•œê¸€ ì§€ì›)</div>

        <div id="status" class="status disconnected">
            ğŸ”´ ì—°ê²° ì•ˆë¨ - ì—°ê²° ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”
        </div>

        <div class="controls">
            <button id="connectBtn" onclick="connectDevice()">ğŸ”— ì—°ê²°</button>
            <button id="disconnectBtn" onclick="disconnectDevice()" disabled>âŒ ì—°ê²° í•´ì œ</button>
        </div>

        <div class="message-area">
            <input type="text" id="messageInput" placeholder="í•œê¸€/ì˜ë¬¸ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
            <button class="send-btn" id="sendBtn" onclick="startCountdown()" disabled>ğŸ“¤ ì „ì†¡</button>
        </div>

        <!-- ë³€í™˜ ë¯¸ë¦¬ë³´ê¸° -->
        <div class="conversion-preview" id="conversionPreview">
            <strong>ğŸ”„ ë³€í™˜ ë¯¸ë¦¬ë³´ê¸°:</strong><br>
            <span id="previewText">ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ë©´ ë³€í™˜ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</span>
            <div class="protocol-info" id="protocolInfo"></div>
        </div>

        <!-- í‚¤ë³´ë“œ í…ŒìŠ¤íŠ¸ ì˜ì—­ -->
        <div class="keyboard-test" id="keyboardTest" style="display: none;">
            <h4>âŒ¨ï¸ í‚¤ë³´ë“œ í…ŒìŠ¤íŠ¸:</h4>
            
            <h5>ğŸ”¤ ì˜ë¬¸ í…ŒìŠ¤íŠ¸:</h5>
            <div class="test-buttons">
                <button class="test-btn" onclick="testText('Hello World!')">Hello World!</button>
                <button class="test-btn" onclick="testText('GHOSTYPE Test 123')">ì˜ë¬¸ í…ŒìŠ¤íŠ¸</button>
                <button class="test-btn" onclick="testText('The quick brown fox')">íƒ€ì´í•‘ ì—°ìŠµ</button>
                <button class="test-btn" onclick="testText('Programming is fun!')">í”„ë¡œê·¸ë˜ë°</button>
            </div>

            <h5>ğŸ‡°ğŸ‡· í•œê¸€ í…ŒìŠ¤íŠ¸:</h5>
            <div class="test-buttons">
                <button class="korean-test-btn" onclick="testText('ì•ˆë…•í•˜ì„¸ìš”')">ì•ˆë…•í•˜ì„¸ìš”</button>
                <button class="korean-test-btn" onclick="testText('í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤')">í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤</button>
                <button class="korean-test-btn" onclick="testText('í•œê¸€ í‚¤ë³´ë“œ')">í•œê¸€ í‚¤ë³´ë“œ</button>
                <button class="korean-test-btn" onclick="testText('í”„ë¡œê·¸ë˜ë°')">í”„ë¡œê·¸ë˜ë°</button>
            </div>

            <h5>ğŸŒ í˜¼í•© í…ŒìŠ¤íŠ¸:</h5>
            <div class="test-buttons">
                <button class="test-btn" onclick="testText('Hello ì•ˆë…•')">Hello ì•ˆë…•</button>
                <button class="test-btn" onclick="testText('GHOSTYPE í•œê¸€')">GHOSTYPE í•œê¸€</button>
                <button class="test-btn" onclick="testText('Programmingì€ ì¬ë¯¸ìˆì–´')">Programmingì€ ì¬ë¯¸ìˆì–´</button>
                <button class="test-btn" onclick="testText('ì˜¤ëŠ˜ ë‚ ì”¨ê°€ niceí•˜ë„¤ìš”')">ì˜¤ëŠ˜ ë‚ ì”¨ê°€ niceí•˜ë„¤ìš”</button>
            </div>

            <h5>ğŸ¹ íŠ¹ìˆ˜ í‚¤:</h5>
            <div class="test-buttons">
                <button class="special-btn" onclick="testSpecial('enter')">Enter</button>
                <button class="special-btn" onclick="testSpecial('tab')">Tab</button>
                <button class="special-btn" onclick="testSpecial('space')">Space</button>
                <button class="special-btn" onclick="testSpecial('backspace')">Backspace</button>
                <button class="special-btn" onclick="testSpecial('ctrl+c')">Ctrl+C</button>
                <button class="special-btn" onclick="testSpecial('ctrl+v')">Ctrl+V</button>
            </div>
        </div>

        <!-- ì¹´ìš´íŠ¸ë‹¤ìš´ ëª¨ë‹¬ -->
        <div id="countdownModal" class="countdown-modal" style="display: none;">
            <div class="countdown-content">
                <h3>âŒ¨ï¸ í‚¤ë³´ë“œ ì…ë ¥ ì¤€ë¹„</h3>
                <div class="countdown-number" id="countdownNumber">5</div>
                <div class="countdown-message" id="countdownMessage">ë©”ëª¨ì¥ì— ì»¤ì„œë¥¼ ë†“ê³  ê¸°ë‹¤ë¦¬ì„¸ìš”...</div>
                <div class="countdown-preview" id="countdownPreview">
                    <strong>ì›ë³¸:</strong> <span id="originalText"></span><br>
                    <strong>ë³€í™˜:</strong> <span id="convertedText"></span><br>
                    <strong>í”„ë¡œí† ì½œ:</strong> <span id="protocolText"></span>
                </div>
                <button class="cancel-btn" onclick="cancelCountdown()">âŒ ì·¨ì†Œ</button>
            </div>
        </div>

        <div class="log" id="log">
            <div class="log-entry log-info">ğŸŒ Web Bluetooth ì¤€ë¹„ë¨ (í•œê¸€ ìëª¨ ë³€í™˜ ì§€ì›)</div>
        </div>

        <div class="info-box">
            <h4>ğŸ“‹ ì‚¬ìš© ë°©ë²•:</h4>
            <ul>
                <li><strong>Chrome/Edge ë¸Œë¼ìš°ì €</strong>ì—ì„œë§Œ ë™ì‘í•©ë‹ˆë‹¤</li>
                <li>ì—°ê²° ë²„íŠ¼ì„ ëˆ„ë¥´ê³  <strong>"GHOSTYPE-6FED"</strong> ì„ íƒ</li>
                <li><strong>í•œê¸€/ì˜ë¬¸/í˜¼í•© í…ìŠ¤íŠ¸</strong> ëª¨ë‘ ì§€ì›ë©ë‹ˆë‹¤</li>
                <li>í•œê¸€ì€ ìë™ìœ¼ë¡œ <strong>ìëª¨ í‚¤ ì¡°í•©</strong>ìœ¼ë¡œ ë³€í™˜ë©ë‹ˆë‹¤</li>
                <li>ì…ë ¥ ì „ <strong>5ì´ˆ ì¹´ìš´íŠ¸ë‹¤ìš´</strong>ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ì „ì†¡</li>
                <li>ë©”ëª¨ì¥ì„ ì—´ì–´ë‘ê³  í…ŒìŠ¤íŠ¸í•´ë³´ì„¸ìš”!</li>
            </ul>
        </div>

        <div class="footer">
            ğŸ’¡ í•œê¸€ ì§€ì›: ã„±-ã…, ã…-ã…£ ìëª¨ë¥¼ QWERTY í‚¤ë¡œ ìë™ ë³€í™˜
        </div>
    </div>

    <script>
        // BLE ì„œë¹„ìŠ¤ ë° íŠ¹ì„± UUID
        const SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
        const RX_CHAR_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e';
        const TX_CHAR_UUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e';

        let device = null;
        let server = null;
        let service = null;
        let rxCharacteristic = null;
        let txCharacteristic = null;
        let countdownTimer = null;
        let countdownPending = null;

        // ===== í•œê¸€ â†’ ìëª¨ í‚¤ ë³€í™˜ ë¡œì§ =====

        // ë‘ë²Œì‹ í‚¤ë³´ë“œ ë§¤í•‘ í…Œì´ë¸”
        const QWERTY_TO_JAMO = {
            // ììŒ (ì™¼ì†)
            'q': 'ã…‚', 'w': 'ã…ˆ', 'e': 'ã„·', 'r': 'ã„±', 't': 'ã……',
            'a': 'ã…', 's': 'ã„´', 'd': 'ã…‡', 'f': 'ã„¹', 'g': 'ã…',
            'z': 'ã…‹', 'x': 'ã…Œ', 'c': 'ã…Š', 'v': 'ã…',
            
            // ëª¨ìŒ (ì˜¤ë¥¸ì†)
            'y': 'ã…›', 'u': 'ã…•', 'i': 'ã…‘', 'o': 'ã…', 'p': 'ã…”',
            'h': 'ã…—', 'j': 'ã…“', 'k': 'ã…', 'l': 'ã…£',
            'b': 'ã… ', 'n': 'ã…œ', 'm': 'ã…¡',
            
            // Shift ì¡°í•©
            'Q': 'ã…ƒ', 'W': 'ã…‰', 'E': 'ã„¸', 'R': 'ã„²', 'T': 'ã…†',
            'O': 'ã…’', 'P': 'ã…–'
        };

        // ì—­ë°©í–¥ ë§¤í•‘ (ìëª¨ â†’ QWERTY)
        const JAMO_TO_QWERTY = {};
        Object.keys(QWERTY_TO_JAMO).forEach(key => {
            JAMO_TO_QWERTY[QWERTY_TO_JAMO[key]] = key;
        });

        // í•œê¸€ ìœ ë‹ˆì½”ë“œ ë¶„í•´ í•¨ìˆ˜
        function decomposeHangul(char) {
            const code = char.charCodeAt(0);
            
            // í•œê¸€ ì™„ì„±í˜• ë²”ìœ„ ì²´í¬ (ê°€-í£)
            if (code < 0xAC00 || code > 0xD7A3) {
                return null;
            }
            
            const base = code - 0xAC00;
            const cho = Math.floor(base / 588);           // ì´ˆì„±
            const jung = Math.floor((base % 588) / 28);   // ì¤‘ì„±
            const jong = base % 28;                       // ì¢…ì„±
            
            // ìëª¨ ë°°ì—´
            const chosung = ['ã„±','ã„²','ã„´','ã„·','ã„¸','ã„¹','ã…','ã…‚','ã…ƒ','ã……','ã…†','ã…‡','ã…ˆ','ã…‰','ã…Š','ã…‹','ã…Œ','ã…','ã…'];
            const jungsung = ['ã…','ã…','ã…‘','ã…’','ã…“','ã…”','ã…•','ã…–','ã…—','ã…˜','ã…™','ã…š','ã…›','ã…œ','ã…','ã…','ã…Ÿ','ã… ','ã…¡','ã…¢','ã…£'];
            const jongsung = ['','ã„±','ã„²','ã„±ã……','ã„´','ã„´ã…ˆ','ã„´ã…','ã„·','ã„¹','ã„¹ã„±','ã„¹ã…','ã„¹ã…‚','ã„¹ã……','ã„¹ã…Œ','ã„¹ã…','ã„¹ã…','ã…','ã…‚','ã…‚ã……','ã……','ã…†','ã…‡','ã…ˆ','ã…Š','ã…‹','ã…Œ','ã…','ã…'];
            
            const result = [];
            result.push(chosung[cho]);
            result.push(jungsung[jung]);
            if (jong > 0) {
                const jongChar = jongsung[jong];
                if (jongChar.length === 2) {
                    // ë³µí•© ì¢…ì„± (ì˜ˆ: ã„±ã……)
                    result.push(jongChar[0]);
                    result.push(jongChar[1]);
                } else {
                    result.push(jongChar);
                }
            }
            
            return result;
        }

        // ìëª¨ë¥¼ QWERTY í‚¤ë¡œ ë³€í™˜
        function jamoToQwerty(jamo) {
            return JAMO_TO_QWERTY[jamo] || jamo;
        }

        // í•œê¸€ í…ìŠ¤íŠ¸ë¥¼ ìëª¨ í‚¤ ì¡°í•©ìœ¼ë¡œ ë³€í™˜
        function convertHangulToJamoKeys(text) {
            let result = '';
            
            for (let char of text) {
                const jamos = decomposeHangul(char);
                if (jamos) {
                    // í•œê¸€ì¸ ê²½ìš° ìëª¨ë¡œ ë¶„í•´ í›„ QWERTY í‚¤ë¡œ ë³€í™˜
                    for (let jamo of jamos) {
                        result += jamoToQwerty(jamo);
                    }
                } else {
                    // í•œê¸€ì´ ì•„ë‹Œ ê²½ìš° ê·¸ëŒ€ë¡œ
                    result += char;
                }
            }
            
            return result;
        }

        // í…ìŠ¤íŠ¸ íƒ€ì… ë¶„ì„
        function analyzeText(text) {
            let hasKorean = false;
            let hasEnglish = false;
            let hasSpecial = false;
            
            for (let char of text) {
                const code = char.charCodeAt(0);
                if (code >= 0xAC00 && code <= 0xD7A3) {
                    hasKorean = true;
                } else if ((code >= 65 && code <= 90) || (code >= 97 && code <= 122)) {
                    hasEnglish = true;
                } else if (code >= 32 && code <= 126) {
                    hasSpecial = true;
                }
            }
            
            if (hasKorean && hasEnglish) return 'mixed';
            if (hasKorean) return 'korean';
            if (hasEnglish || hasSpecial) return 'english';
            return 'unknown';
        }

        // ìŠ¤ë§ˆíŠ¸ í…ìŠ¤íŠ¸ ë³€í™˜ (í”„ë¡œí† ì½œ í¬í•¨)
        function convertTextWithProtocol(text) {
            const type = analyzeText(text);
            
            if (type === 'korean' || type === 'mixed') {
                // í•œê¸€ì´ í¬í•¨ëœ ê²½ìš°: ìëª¨ í‚¤ë¡œ ë³€í™˜ í›„ í•œê¸€ í”„ë¡œí† ì½œ
                const jamoKeys = convertHangulToJamoKeys(text);
                return {
                    original: text,
                    converted: jamoKeys,
                    protocol: `GHTYPE_KOR:${jamoKeys}`,
                    type: type,
                    description: 'í•œê¸€ ìëª¨ í‚¤ ë³€í™˜'
                };
            } else {
                // ìˆœìˆ˜ ì˜ë¬¸ì¸ ê²½ìš°: ì˜ë¬¸ í”„ë¡œí† ì½œ
                return {
                    original: text,
                    converted: text,
                    protocol: `GHTYPE_ENG:${text}`,
                    type: 'english',
                    description: 'ì˜ë¬¸ ì§ì ‘ ì…ë ¥'
                };
            }
        }

        // ì‹¤ì‹œê°„ ë³€í™˜ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        function updateConversionPreview() {
            const input = document.getElementById('messageInput');
            const preview = document.getElementById('conversionPreview');
            const previewText = document.getElementById('previewText');
            const protocolInfo = document.getElementById('protocolInfo');
            const text = input.value;
            
            if (!text) {
                preview.className = 'conversion-preview';
                previewText.textContent = 'ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ë©´ ë³€í™˜ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤';
                protocolInfo.textContent = '';
                return;
            }
            
            const result = convertTextWithProtocol(text);
            
            // ë¯¸ë¦¬ë³´ê¸° ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            preview.className = `conversion-preview ${result.type}`;
            
            // ë³€í™˜ ê²°ê³¼ í‘œì‹œ
            if (result.type === 'korean' || result.type === 'mixed') {
                previewText.innerHTML = `
                    <strong>ì›ë³¸:</strong> ${result.original}<br>
                    <strong>ìëª¨:</strong> ${result.converted}<br>
                    <strong>ì„¤ëª…:</strong> ${result.description}
                `;
            } else {
                previewText.innerHTML = `
                    <strong>í…ìŠ¤íŠ¸:</strong> ${result.original}<br>
                    <strong>ì„¤ëª…:</strong> ${result.description}
                `;
            }
            
            protocolInfo.textContent = `ì „ì†¡ í”„ë¡œí† ì½œ: ${result.protocol}`;
        }

        // ===== BLE í†µì‹  í•¨ìˆ˜ë“¤ =====

        function addLog(message, type = 'info') {
            const log = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        function updateStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        function updateUI(connected) {
            document.getElementById('connectBtn').disabled = connected;
            document.getElementById('disconnectBtn').disabled = !connected;
            // ì…ë ¥ì°½ì€ í•­ìƒ í™œì„±í™” (ë¯¸ë¦¬ë³´ê¸°ë¥¼ ìœ„í•´)
            // document.getElementById('messageInput').disabled = !connected;
            document.getElementById('sendBtn').disabled = !connected;
            
            const keyboardTest = document.getElementById('keyboardTest');
            
            if (connected) {
                keyboardTest.style.display = 'block';
                addLog('ğŸ‡°ğŸ‡· í•œê¸€ ìëª¨ ë³€í™˜ ê¸°ëŠ¥ í™œì„±í™”', 'info');
                addLog('âŒ¨ï¸ ëª¨ë“  í•œê¸€ì´ ìë™ìœ¼ë¡œ ìëª¨ í‚¤ë¡œ ë³€í™˜ë©ë‹ˆë‹¤', 'info');
            } else {
                keyboardTest.style.display = 'none';
            }
        }

        // ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘
        function startCountdown() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) {
                addLog('âš ï¸ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
                return;
            }

            if (!rxCharacteristic) {
                addLog('âŒ ë¨¼ì € GHOSTYPE ë””ë°”ì´ìŠ¤ì— ì—°ê²°í•˜ì„¸ìš”', 'error');
                return;
            }

            const result = convertTextWithProtocol(message);
            startCountdownWithResult(result, () => {
                sendData(result.protocol);
                input.value = '';
                updateConversionPreview();
            });
        }

        // í…ŒìŠ¤íŠ¸ í…ìŠ¤íŠ¸ ì „ì†¡
        function testText(text) {
            const result = convertTextWithProtocol(text);
            startCountdownWithResult(result, () => {
                sendData(result.protocol);
            });
        }

        // íŠ¹ìˆ˜ í‚¤ ì „ì†¡
        function testSpecial(command) {
            const protocol = `GHTYPE_SPE:${command}`;
            const result = {
                original: command,
                converted: command,
                protocol: protocol,
                type: 'special',
                description: 'íŠ¹ìˆ˜ í‚¤ ëª…ë ¹'
            };
            
            startCountdownWithResult(result, () => {
                sendData(protocol);
            });
        }

        // ì¹´ìš´íŠ¸ë‹¤ìš´ (ë³€í™˜ ê²°ê³¼ í¬í•¨)
        function startCountdownWithResult(result, callback) {
            if (!rxCharacteristic) {
                addLog('âŒ ì—°ê²°ë˜ì§€ ì•ŠìŒ', 'error');
                return;
            }

            const modal = document.getElementById('countdownModal');
            const numberEl = document.getElementById('countdownNumber');
            const messageEl = document.getElementById('countdownMessage');
            const originalEl = document.getElementById('originalText');
            const convertedEl = document.getElementById('convertedText');
            const protocolEl = document.getElementById('protocolText');
            
            modal.style.display = 'flex';
            originalEl.textContent = result.original;
            convertedEl.textContent = result.converted;
            protocolEl.textContent = result.protocol;
            
            let count = 5;
            countdownPending = callback;
            
            function updateCountdown() {
                numberEl.textContent = count;
                
                if (count > 0) {
                    messageEl.textContent = `${count}ì´ˆ í›„ ì…ë ¥ì´ ì‹œì‘ë©ë‹ˆë‹¤...`;
                    count--;
                    countdownTimer = setTimeout(updateCountdown, 1000);
                } else {
                    messageEl.textContent = 'ì…ë ¥ ì¤‘... âŒ¨ï¸';
                    numberEl.textContent = 'âŒ¨ï¸';
                    numberEl.style.animation = 'none';
                    
                    setTimeout(() => {
                        modal.style.display = 'none';
                        if (countdownPending) {
                            countdownPending();
                            countdownPending = null;
                            addLog(`âŒ¨ï¸ ì „ì†¡: ${result.description} - "${result.original}"`, 'success');
                        }
                        numberEl.style.animation = 'pulse 1s ease-in-out infinite';
                    }, 1000);
                }
            }
            
            updateCountdown();
            addLog(`â° 5ì´ˆ ì¹´ìš´íŠ¸ë‹¤ìš´: ${result.description}`, 'info');
        }

        function cancelCountdown() {
            if (countdownTimer) {
                clearTimeout(countdownTimer);
                countdownTimer = null;
            }
            countdownPending = null;
            
            const modal = document.getElementById('countdownModal');
            modal.style.display = 'none';
            
            addLog('âŒ ì…ë ¥ ì·¨ì†Œë¨', 'info');
        }

        // BLE ì—°ê²°
        async function connectDevice() {
            try {
                addLog('ğŸ” GHOSTYPE ë””ë°”ì´ìŠ¤ ê²€ìƒ‰ ì¤‘...', 'info');
                updateStatus('ğŸ” ë””ë°”ì´ìŠ¤ ê²€ìƒ‰ ì¤‘...', 'connecting');

                device = await navigator.bluetooth.requestDevice({
                    filters: [
                        { namePrefix: 'GHOSTYPE' },
                        { services: [SERVICE_UUID] }
                    ],
                    optionalServices: [SERVICE_UUID]
                });

                addLog(`ğŸ“± ë””ë°”ì´ìŠ¤ ë°œê²¬: ${device.name}`, 'success');
                device.addEventListener('gattserverdisconnected', onDisconnected);

                addLog('ğŸ”— GATT ì„œë²„ ì—°ê²° ì¤‘...', 'info');
                server = await device.gatt.connect();

                addLog('ğŸ“¡ Nordic UART ì„œë¹„ìŠ¤ ê²€ìƒ‰ ì¤‘...', 'info');
                service = await server.getPrimaryService(SERVICE_UUID);

                addLog('ğŸ”§ íŠ¹ì„± ì„¤ì • ì¤‘...', 'info');
                rxCharacteristic = await service.getCharacteristic(RX_CHAR_UUID);
                txCharacteristic = await service.getCharacteristic(TX_CHAR_UUID);

                await txCharacteristic.startNotifications();
                txCharacteristic.addEventListener('characteristicvaluechanged', onDataReceived);

                addLog('ğŸ‰ ì—°ê²° ì™„ë£Œ! í•œê¸€/ì˜ë¬¸ ëª¨ë‘ ì§€ì›ë©ë‹ˆë‹¤', 'success');
                updateStatus('ğŸŸ¢ ì—°ê²°ë¨ - í•œê¸€/ì˜ë¬¸ ì…ë ¥ ê°€ëŠ¥', 'connected');
                updateUI(true);

                // í™˜ì˜ ë©”ì‹œì§€ (í•œê¸€ í…ŒìŠ¤íŠ¸)
                setTimeout(() => {
                    testText('ğŸŒ ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!');
                }, 1000);

            } catch (error) {
                addLog(`âŒ ì—°ê²° ì‹¤íŒ¨: ${error.message}`, 'error');
                updateStatus('ğŸ”´ ì—°ê²° ì‹¤íŒ¨', 'disconnected');
                console.error('Connection failed:', error);
            }
        }

        function onDataReceived(event) {
            const value = new TextDecoder().decode(event.target.value);
            addLog(`ğŸ“¨ ESP32 ì‘ë‹µ: "${value}"`, 'data');
        }

        function onDisconnected() {
            addLog('ğŸ‘‹ ë””ë°”ì´ìŠ¤ ì—°ê²° í•´ì œë¨', 'info');
            updateStatus('ğŸ”´ ì—°ê²° í•´ì œë¨', 'disconnected');
            updateUI(false);
            
            device = null;
            server = null;
            service = null;
            rxCharacteristic = null;
            txCharacteristic = null;
        }

        async function disconnectDevice() {
            if (device && device.gatt.connected) {
                await device.gatt.disconnect();
            }
        }

        async function sendData(message) {
            if (!rxCharacteristic) {
                addLog('âŒ ì—°ê²°ë˜ì§€ ì•ŠìŒ', 'error');
                return false;
            }

            try {
                const encoder = new TextEncoder();
                const data = encoder.encode(message);
                
                await rxCharacteristic.writeValue(data);
                addLog(`ğŸ“¤ í”„ë¡œí† ì½œ ì „ì†¡: "${message}"`, 'success');
                return true;
            } catch (error) {
                addLog(`âŒ ì „ì†¡ ì‹¤íŒ¨: ${error.message}`, 'error');
                return false;
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('messageInput').addEventListener('input', updateConversionPreview);
        document.getElementById('messageInput').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                startCountdown();
            }
        });

        // Web Bluetooth ì§€ì› í™•ì¸
        if (!navigator.bluetooth) {
            addLog('âŒ ì´ ë¸Œë¼ìš°ì €ëŠ” Web Bluetoothë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤', 'error');
            updateStatus('ğŸš« Web Bluetooth ë¯¸ì§€ì›', 'disconnected');
        }

        // ì´ˆê¸° ìƒíƒœ
        updateUI(false);
        updateConversionPreview();
        addLog('ğŸ’¡ ì—°ê²° í›„ í•œê¸€/ì˜ë¬¸ì„ ììœ ë¡­ê²Œ ì…ë ¥í•´ë³´ì„¸ìš”!', 'info');
    </script>
</body>
</html>