# GHOSTYPE ESP32 펌웨어

## 개요

GHOSTYPE는 BLE 통신을 통해 수신한 타이핑 명령을 USB HID 키보드로 실행하는 ESP32-S3 기반 펌웨어입니다.

## 아키텍처

### 모듈 구조

```
main.cpp              - 메인 엔트리 포인트 및 시스템 제어
├── config.h          - 시스템 설정 및 상수
├── ble_manager.*     - BLE 통신 관리
├── parser.*          - 데이터 파싱 및 명령 해석
├── typing_handler.*  - 타이핑 실행 및 제어
└── hid_utils.*       - USB HID 키보드 제어
```

### 데이터 흐름

```
BLE 클라이언트 → BLE Manager → Parser → Typing Handler → HID Utils → USB HID
```

## 주요 기능

### 1. BLE 통신
- **장치명**: GHOSTYPE
- **서비스 UUID**: `12345678-1234-5678-9012-123456789abc`
- **안정적인 연결 관리**: 자동 재연결, 오류 복구
- **데이터 버퍼링**: 안전한 수신 및 전송

### 2. 메시지 파싱
- **JSON 형식 지원**: `{"text":"Hello", "speed_cps":6, "interval_ms":100}`
- **일반 텍스트 지원**: 단순 문자열
- **토글 마커 처리**: `⌨HANGUL_TOGGLE⌨` 감지 및 분할
- **입력 검증**: 안전성 및 유효성 검사

### 3. 타이핑 실행
- **가변 속도**: 1-50 CPS (Characters Per Second)
- **한영 토글**: 자동 언어 전환 키 처리
- **자연스러운 타이핑**: 랜덤 변동성 포함
- **안전 모드**: 메모리 및 성능 보호

### 4. HID 키보드
- **USB HID 인터페이스**: 표준 키보드로 인식
- **특수 키 지원**: Enter, Tab, Shift 등
- **안전한 키 관리**: 키 누름/해제 보장

## 시스템 상태

### LED 상태 표시 (GPIO2)
- **초기화 중**: 빠른 깜빡임 (100ms)
- **준비 완료**: 천천히 깜빡임 (1000ms)
- **BLE 연결됨**: 계속 켜짐
- **타이핑 중**: 매우 빠른 깜빡임 (50ms)
- **오류 상태**: 빠른 깜빡임 (200ms)

### 시스템 상태
```cpp
enum SystemState {
    SYSTEM_INITIALIZING,  // 시스템 초기화 중
    SYSTEM_READY,         // 시스템 준비 완료
    SYSTEM_CONNECTED,     // BLE 연결됨
    SYSTEM_TYPING,        // 타이핑 중
    SYSTEM_ERROR          // 오류 상태
};
```

## 설정 및 상수

### 기본 설정 (`config.h`)
- **타이핑 속도**: 6 CPS (기본값)
- **버퍼 크기**: 512바이트
- **타임아웃**: 5분 (타이핑), 30초 (연결)
- **메모리 제한**: 256바이트 (청크 크기)

### BLE 설정
- **MTU**: 기본값 (호환성 우선)
- **연결 간격**: 7.5ms - 22.5ms
- **광고 모드**: 연속 광고

## 빌드 및 배포

### 요구사항
- **하드웨어**: ESP32-S3 DevKit
- **프레임워크**: Arduino
- **라이브러리**: 
  - NimBLE-Arduino ^1.4.0
  - ArduinoJson ^6.21.4

### 빌드 명령
```bash
pio run -t upload
```

### 설정 파일
- **PlatformIO**: `platformio.ini`
- **파티션**: `default_16MB.csv`

## API 참조

### BLE 명령 형식

#### JSON 명령
```json
{
  "text": "Hello 안녕하세요",
  "speed_cps": 6,
  "interval_ms": 100
}
```

#### 응답 형식
- **성공**: `OK:45` (타이핑된 문자 수)
- **실패**: `ERR:INVALID_COMMAND`

### 오류 코드
- `ERR:BUSY` - 타이핑 중 (새 명령 거부)
- `ERR:INVALID_DATA` - 잘못된 데이터
- `ERR:INVALID_COMMAND` - 잘못된 명령
- `ERR:TYPING_FAILED` - 타이핑 실행 실패

## 메모리 관리

### 최적화 기법
- **정적 할당**: 동적 메모리 사용 최소화
- **버퍼 재사용**: 수신 버퍼 순환 사용
- **메모리 모니터링**: 주기적 메모리 사용량 확인
- **안전 모드**: 메모리 부족 시 보호 모드

### 메모리 사용량
- **수신 버퍼**: 512바이트
- **JSON 파서**: 1KB
- **스택 사용**: 최소화

## 성능 특성

### 처리 성능
- **최대 타이핑 속도**: 50 CPS
- **지연 시간**: < 50ms (수신-실행)
- **메모리 효율성**: < 50KB 사용
- **배터리 효율성**: BLE 저전력 모드

### 안정성
- **와치독 보호**: 시스템 데드락 방지
- **예외 처리**: 모든 함수에 오류 처리
- **메모리 보호**: 버퍼 오버플로 방지
- **타임아웃 관리**: 무한 대기 방지

## 개발자 가이드

### 코드 스타일
- **언어**: C++17
- **주석**: 한국어 (함수 및 로직 설명)
- **네이밍**: camelCase (변수), PascalCase (클래스)
- **오류 처리**: 모든 함수에 반환값 검증

### 확장 방법
1. **새로운 명령 추가**: `parser.cpp`에 파싱 로직 추가
2. **HID 기능 확장**: `hid_utils.cpp`에 새로운 키 조합 추가
3. **BLE 기능 개선**: `ble_manager.cpp`에 새로운 특성 추가

### 디버깅
- **LED 패턴**: 시스템 상태 확인
- **시리얼 출력**: 프로덕션에서는 비활성화
- **성능 모니터**: 메모리 및 처리 시간 추적

## 라이선스

이 펌웨어는 프로덕션 사용을 위해 최적화되었습니다.
모든 로깅은 제거되고 성능과 안정성을 우선으로 설계되었습니다.