# ESP32 BLE 연결 문제 해결 가이드

## 현재 문제: 검색은 되지만 연결 실패

### 1. 시리얼 포트 충돌 해결
```
오류: ClearCommError failed (PermissionError(13, '장치가 명령을 인식하지 않습니다.'))
```

**해결 단계:**

1. **시리얼 모니터 종료**
   - PlatformIO Serial Monitor 완전 종료
   - Arduino IDE Serial Monitor 종료
   - 모든 시리얼 연결 프로그램 종료

2. **ESP32 하드 리셋**
   - ESP32 전원을 완전히 끄기 (USB 분리)
   - 5초 대기
   - USB 다시 연결
   - BOOT 버튼 누르고 있다가 RESET 버튼 눌렀다 놓기

3. **BLE 연결 테스트**
   - 시리얼 모니터 없이 ESP32만 전원 공급
   - 웹 페이지에서 BLE 연결 시도
   - Chrome의 `chrome://bluetooth-internals/` 에서 상세 로그 확인

### 2. BLE 스택 최적화 적용됨

```cpp
// 현재 설정 (최대 호환성)
- MTU: 247바이트
- 보안: 기본값 (설정 제거)
- 광고: 기본 간격
- 전력: 최대
```

### 3. 연결 순서

1. **ESP32 준비**
   ```
   1. 펌웨어 업로드
   2. 시리얼 모니터 종료
   3. ESP32 리셋 (BOOT+RESET)
   4. 5초 대기
   ```

2. **웹 연결**
   ```
   1. Chrome 브라우저 열기
   2. GHOSTYPE 웹 페이지 접속
   3. "Connect to GHOSTYPE" 클릭
   4. GHOSTYPE 선택
   ```

### 4. 문제 진단

**A. 검색되지 않는 경우:**
- ESP32 전원 확인
- 펌웨어 업로드 확인
- 1m 이내 근거리 테스트

**B. 검색되지만 연결 실패:**
- 시리얼 포트 충돌 → 모든 시리얼 프로그램 종료
- BLE 스택 충돌 → ESP32 하드 리셋
- 브라우저 캐시 → Chrome 재시작

**C. 연결되지만 데이터 전송 실패:**
- MTU 크기 확인 (247바이트 이하)
- JSON 형식 확인
- 특성 권한 확인

### 5. Chrome Bluetooth 진단

1. `chrome://bluetooth-internals/` 접속
2. "Adapter" 탭에서 블루투스 어댑터 상태 확인
3. "Devices" 탭에서 GHOSTYPE 장치 확인
4. 연결 시도 시 로그 모니터링

### 6. 임시 해결책

**시리얼 충돌이 계속되는 경우:**
1. ESP32를 다른 USB 포트에 연결
2. 다른 컴퓨터에서 테스트
3. USB 허브 사용 시 직접 연결로 변경

**BLE 연결이 불안정한 경우:**
1. ESP32와 컴퓨터 거리 50cm 이내
2. WiFi 2.4GHz 간섭 최소화
3. 다른 BLE 장치들 끄기

### 7. 성공적인 연결 확인

```
웹 페이지 로그:
✅ GHOSTYPE 장치 검색 중...
✅ 장치 발견: GHOSTYPE
✅ GATT 서버 연결 성공
✅ 서비스 발견
✅ 특성 설정 완료
✅ GHOSTYPE 장치 연결 완료!
```

### 8. 다음 단계

연결 성공 후:
1. 간단한 텍스트 "Hello" 테스트
2. 한글 텍스트 "안녕" 테스트  
3. 혼합 텍스트 "Hello 안녕" 테스트