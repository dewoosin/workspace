<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GHOSTYPE - Smart Korean-English Typing</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .status {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 5px;
            background: #f8f9fa;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
            background: #dc3545;
        }
        
        .status.connected .status-indicator {
            background: #28a745;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        textarea {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            resize: vertical;
        }
        
        textarea:focus {
            outline: none;
            border-color: #007bff;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        input[type="range"] {
            flex: 1;
        }
        
        .preview {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
            word-break: break-all;
        }
        
        .preview h3 {
            margin-bottom: 10px;
            font-size: 16px;
            color: #666;
        }
        
        .test-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }
        
        .test-buttons button {
            font-size: 14px;
            padding: 8px 16px;
        }
        
        .log {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        
        .log-entry.error {
            color: #dc3545;
        }
        
        .log-entry.success {
            color: #28a745;
        }
    </style>
</head>
<body>
    <h1>GHOSTYPE - Ïä§ÎßàÌä∏ ÌïúÏòÅ ÌÉÄÏù¥Ìïë üéπ</h1>
    
    <div class="container">
        <!-- Connection Status -->
        <div class="status" id="status">
            <div class="status-indicator"></div>
            <span id="statusText">Disconnected</span>
        </div>
        
        <!-- Connection Button -->
        <div class="controls">
            <button id="connectBtn" class="btn-primary">Connect to GHOSTYPE</button>
            <button id="disconnectBtn" class="btn-secondary" disabled>Disconnect</button>
        </div>
        
        <!-- Text Input -->
        <div class="input-group">
            <label for="textInput">Enter Text (Korean/English Mixed)</label>
            <textarea id="textInput" placeholder="Hello ÏïàÎÖïÌïòÏÑ∏Ïöî! Mix Korean and English freely..."></textarea>
        </div>
        
        <!-- Speed Control -->
        <div class="speed-control">
            <label for="speedSlider">Typing Speed:</label>
            <input type="range" id="speedSlider" min="1" max="20" value="6">
            <span id="speedValue">6 CPS</span>
        </div>
        
        <!-- Send Controls -->
        <div class="controls">
            <button id="sendBtn" class="btn-success" disabled>Send Text</button>
            <button id="sendWithEnterBtn" class="btn-success" disabled>Send + Enter</button>
            <button id="clearBtn" class="btn-secondary">Clear</button>
        </div>
        
        <!-- Preview -->
        <div class="preview" id="preview" style="display: none;">
            <h3>Preprocessed Output:</h3>
            <div id="previewText"></div>
        </div>
        
        <!-- Test Buttons -->
        <div class="test-buttons">
            <button class="btn-secondary" onclick="setTestText('Hello World!')">English Only</button>
            <button class="btn-secondary" onclick="setTestText('ÏïàÎÖïÌïòÏÑ∏Ïöî')">Korean Only</button>
            <button class="btn-secondary" onclick="setTestText('Hello ÏïàÎÖï World!')">Mixed Simple</button>
            <button class="btn-secondary" onclick="setTestText('ÎåÄÌïúÎØºÍµ≠ Korea ÌôîÏù¥ÌåÖ!')">Mixed Complex</button>
            <button class="btn-secondary" onclick="setTestText('Test Îêò vs Îèº example')">Îêò/Îèº Test</button>
            <button class="btn-secondary" onclick="setTestText('ÎßëÏùÄ sky ÎÑìÏùÄ sea')">Complex Jamo</button>
            <button class="btn-secondary" onclick="runBLEDiagnostics()" style="background: #fd7e14; border-color: #fd7e14;">üîß Run Diagnostics</button>
            <button class="btn-secondary" onclick="testBLEConnection()" style="background: #17a2b8; border-color: #17a2b8;">üß™ Simple Test</button>
            <button class="btn-secondary" onclick="simpleScanTest()" style="background: #6f42c1; border-color: #6f42c1;">üîç Scan All</button>
        </div>
        
        <!-- Log -->
        <div class="log" id="log"></div>
    </div>
    
    <!-- Load JavaScript -->
    <script src="hangulPreprocessor.js"></script>
    <script src="webBLEInterface.js"></script>
    <script src="bleConnectionDiagnostics.js"></script>
    <script src="bleDebugTest.js"></script>
    <script>
        // Initialize
        let ble = null;
        let preprocessor = null;
        
        // DOM elements
        const statusEl = document.getElementById('status');
        const statusTextEl = document.getElementById('statusText');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const textInput = document.getElementById('textInput');
        const sendBtn = document.getElementById('sendBtn');
        const sendWithEnterBtn = document.getElementById('sendWithEnterBtn');
        const clearBtn = document.getElementById('clearBtn');
        const speedSlider = document.getElementById('speedSlider');
        const speedValue = document.getElementById('speedValue');
        const preview = document.getElementById('preview');
        const previewText = document.getElementById('previewText');
        const logEl = document.getElementById('log');
        
        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            ble = new WebBLEInterface();
            preprocessor = new HangulPreprocessor();
            
            log('System initialized', 'success');
        });
        
        // Connect button handler
        connectBtn.addEventListener('click', async () => {
            try {
                connectBtn.disabled = true;
                log('Connecting to GHOSTYPE...');
                
                await ble.connect();
                
                statusEl.classList.add('connected');
                statusTextEl.textContent = 'Connected to GHOSTYPE';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                sendBtn.disabled = false;
                sendWithEnterBtn.disabled = false;
                
                log('Connected successfully!', 'success');
            } catch (error) {
                connectBtn.disabled = false;
                log('Connection failed: ' + error.message, 'error');
            }
        });
        
        // Disconnect button handler
        disconnectBtn.addEventListener('click', () => {
            ble.disconnect();
            
            statusEl.classList.remove('connected');
            statusTextEl.textContent = 'Disconnected';
            connectBtn.disabled = false;
            disconnectBtn.disabled = true;
            sendBtn.disabled = true;
            sendWithEnterBtn.disabled = true;
            
            log('Disconnected');
        });
        
        // Send button handler
        sendBtn.addEventListener('click', async () => {
            const text = textInput.value; // trim() Ï†úÍ±∞ - Ï§ÑÎ∞îÍøà Î≥¥Ï°¥
            if (!text) {
                log('Please enter some text', 'error');
                return;
            }
            
            try {
                sendBtn.disabled = true;
                const speed = parseInt(speedSlider.value);
                
                log(`Sending text (${speed} CPS): "${text.replace(/\n/g, '\\n')}"`);
                await ble.sendText(text, { speed_cps: speed });
                
                log('Text sent successfully!', 'success');
            } catch (error) {
                log('Send failed: ' + error.message, 'error');
            } finally {
                sendBtn.disabled = false;
            }
        });
        
        // Send with Enter button handler
        sendWithEnterBtn.addEventListener('click', async () => {
            const text = textInput.value; // trim() Ï†úÍ±∞ - Ï§ÑÎ∞îÍøà Î≥¥Ï°¥
            if (!text) {
                log('Please enter some text', 'error');
                return;
            }
            
            try {
                sendWithEnterBtn.disabled = true;
                const speed = parseInt(speedSlider.value);
                
                // Add newline to the text
                const textWithEnter = text + '\n';
                
                log(`Sending text with Enter (${speed} CPS): "${text.replace(/\n/g, '\\n')} + Enter"`);
                await ble.sendText(textWithEnter, { speed_cps: speed });
                
                log('Text sent with Enter successfully!', 'success');
            } catch (error) {
                log('Send failed: ' + error.message, 'error');
            } finally {
                sendWithEnterBtn.disabled = false;
            }
        });
        
        // Clear button handler
        clearBtn.addEventListener('click', () => {
            textInput.value = '';
            preview.style.display = 'none';
        });
        
        // Speed slider handler
        speedSlider.addEventListener('input', (e) => {
            speedValue.textContent = e.target.value + ' CPS';
        });
        
        // Text input handler - show preview
        textInput.addEventListener('input', (e) => {
            const text = e.target.value;
            if (text) {
                const processed = preprocessor.formatForESP32(text);
                // ÌäπÏàò Î¨∏ÏûêÎ•º ÌëúÏãúÌïòÎèÑÎ°ù Î≥ÄÌôò
                const displayText = processed.text
                    .replace(/\n/g, '‚Üµ\n')  // ÏóîÌÑ∞ÌÇ§ ÌëúÏãú
                    .replace(/\t/g, '‚Üí\t')  // ÌÉ≠ ÌëúÏãú
                    .replace(/\r/g, '‚Üì');   // Ï∫êÎ¶¨ÏßÄ Î¶¨ÌÑ¥ ÌëúÏãú
                previewText.textContent = displayText;
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }
        });
        
        // Test text setter
        function setTestText(text) {
            textInput.value = text;
            textInput.dispatchEvent(new Event('input'));
        }
        
        // Logging function
        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            if (type === 'error') entry.classList.add('error');
            if (type === 'success') entry.classList.add('success');
            
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        // Check Web Bluetooth support
        if (!navigator.bluetooth) {
            log('Web Bluetooth is not supported in this browser!', 'error');
            connectBtn.disabled = true;
        }
    </script>
</body>
</html>